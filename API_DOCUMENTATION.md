# åœ¨çº¿åˆ¤é¢˜ç³»ç»Ÿç½‘å…³ API æ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯

- **ç‰ˆæœ¬**: v1.0.1
- **æœ€åæ›´æ–°**: 2025-10-19
- **ç»´æŠ¤è€…**: to404hanga

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº Gin + GORM + Redis çš„å¾®æœåŠ¡ç½‘å…³ï¼Œä¸ºåœ¨çº¿åˆ¤é¢˜ç³»ç»Ÿæä¾›ç»Ÿä¸€çš„å…¥å£ç‚¹ï¼ŒåŒ…å«ç”¨æˆ·è®¤è¯ã€æœåŠ¡ä»£ç†å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚

## æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Gin + GORM + Redis
- **è®¤è¯**: JWT (JSON Web Token)
- **è´Ÿè½½å‡è¡¡**: æ”¯æŒè½®è¯¢ã€éšæœºã€åŠ æƒéšæœºã€åŠ æƒè½®è¯¢
- **å¥åº·æ£€æŸ¥**: è‡ªåŠ¨æœåŠ¡å®ä¾‹å¥åº·ç›‘æ§
- **ä¾èµ–æ³¨å…¥**: Wire

## åŸºç¡€ä¿¡æ¯

- **Base URL**: `http://localhost:8080` (é»˜è®¤)
- **Content-Type**: `application/json`
- **è®¤è¯æ–¹å¼**: JWT Token (é€šè¿‡ Cookie)
- **API ç‰ˆæœ¬**: v1

## ç›®å½•

- [è®¤è¯ç›¸å…³ API](#è®¤è¯ç›¸å…³-api)
- [å¥åº·æ£€æŸ¥ API](#å¥åº·æ£€æŸ¥-api)
- [æœåŠ¡ä»£ç† API](#æœåŠ¡ä»£ç†-api)
- [æœåŠ¡ç®¡ç† API](#æœåŠ¡ç®¡ç†-api-ç®¡ç†å‘˜æ¥å£)
- [æ•°æ®æ¨¡å‹](#æ•°æ®æ¨¡å‹)
- [é”™è¯¯ç è¯´æ˜](#é”™è¯¯ç è¯´æ˜)
- [è®¤è¯æœºåˆ¶](#è®¤è¯æœºåˆ¶)
- [è´Ÿè½½å‡è¡¡ç­–ç•¥](#è´Ÿè½½å‡è¡¡ç­–ç•¥)
- [å¥åº·æ£€æŸ¥](#å¥åº·æ£€æŸ¥)
- [ä¸­é—´ä»¶](#ä¸­é—´ä»¶)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [éƒ¨ç½²è¯´æ˜](#éƒ¨ç½²è¯´æ˜)
- [ç‰ˆæœ¬æ›´æ–°è®°å½•](#ç‰ˆæœ¬æ›´æ–°è®°å½•)

## è®¤è¯ç›¸å…³ API

### 1. ç”¨æˆ·ç™»å½•

**æ¥å£åœ°å€**: `POST /auth/login`

**æè¿°**: ç”¨æˆ·ç™»å½•æ¥å£ï¼ŒéªŒè¯ç”¨æˆ·åå’Œå¯†ç ï¼ŒæˆåŠŸåè¿”å› JWT Token

**è¯·æ±‚å¤´**:

```
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**:

```json
{
  "username": "string", // å¿…å¡«ï¼Œç”¨æˆ·åï¼Œé•¿åº¦1-50å­—ç¬¦
  "password": "string" // å¿…å¡«ï¼Œå¯†ç ï¼Œé•¿åº¦6-100å­—ç¬¦
}
```

**å“åº”ç¤ºä¾‹**:

```json
// æˆåŠŸå“åº” (200)
{
  "message": "login success"
}

// å¤±è´¥å“åº” (400)
{
  "error": "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"
}

// å‚æ•°é”™è¯¯ (400)
{
  "error": "Key: 'LoginRequest.Username' Error:Field validation for 'Username' failed on the 'required' tag"
}
```

**è¯´æ˜**:

- ç™»å½•æˆåŠŸåï¼ŒJWT Token ä¼šè‡ªåŠ¨è®¾ç½®åˆ° Cookie ä¸­ (access_token)
- Token åŒ…å«ç”¨æˆ· IDã€ä¼šè¯ ID å’Œç”¨æˆ·ä»£ç†ä¿¡æ¯
- Token æœ‰æ•ˆæœŸå¯é…ç½®ï¼Œé»˜è®¤ 24 å°æ—¶

### 2. ç”¨æˆ·ç™»å‡º

**æ¥å£åœ°å€**: `POST /auth/logout`

**æè¿°**: ç”¨æˆ·ç™»å‡ºæ¥å£ï¼Œæ¸…é™¤ JWT Token

**è¯·æ±‚å¤´**:

```
Cookie: access_token=your_jwt_token
```

**è¯·æ±‚å‚æ•°**: æ— 

**å“åº”ç¤ºä¾‹**:

```json
// æˆåŠŸå“åº” (200)
{
  "message": "logout success"
}

// å¤±è´¥å“åº” (400)
{
  "error": "æ¸…é™¤tokenå¤±è´¥"
}

// æœªè®¤è¯ (401)
{
  "error": "tokenä¸å­˜åœ¨"
}
```

### 3. è·å–ç”¨æˆ·ä¿¡æ¯

**æ¥å£åœ°å€**: `GET /auth/info`

**æè¿°**: è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯

**è¯·æ±‚å¤´**:

```
Cookie: access_token=your_jwt_token
```

**è¯·æ±‚å‚æ•°**: æ—  (éœ€è¦ JWT è®¤è¯)

**å“åº”ç¤ºä¾‹**:

```json
// æˆåŠŸå“åº” (200)
{
  "username": "admin",         // ç”¨æˆ·å
  "realname": "ç®¡ç†å‘˜",        // çœŸå®å§“å
  "role": 1,                   // ç”¨æˆ·è§’è‰² (1=ç®¡ç†å‘˜, 0=æ™®é€šç”¨æˆ·)
  "status": 1                  // ç”¨æˆ·çŠ¶æ€ (1=æ­£å¸¸, 0=ç¦ç”¨)
}

// å¤±è´¥å“åº” (500)
{
  "error": "è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥"
}

// æœªè®¤è¯ (401)
{
  "error": "tokenä¸å­˜åœ¨"
}
```

## å¥åº·æ£€æŸ¥ API

### 4. å¥åº·æ£€æŸ¥

**æ¥å£åœ°å€**: `GET /health`

**æè¿°**: æ£€æŸ¥ç½‘å…³æœåŠ¡å¥åº·çŠ¶æ€

**è¯·æ±‚å‚æ•°**: æ— 

**å“åº”ç¤ºä¾‹**:

```
// æˆåŠŸå“åº” (200)
// æ— å“åº”ä½“ï¼Œä»…è¿”å›çŠ¶æ€ç 
```

**è¯´æ˜**:

- ç”¨äºè´Ÿè½½å‡è¡¡å™¨æˆ–ç›‘æ§ç³»ç»Ÿæ£€æŸ¥æœåŠ¡çŠ¶æ€
- è¿”å› 200 çŠ¶æ€ç è¡¨ç¤ºæœåŠ¡æ­£å¸¸

## æœåŠ¡ä»£ç† API

### 5. æœåŠ¡è½¬å‘

**æ¥å£åœ°å€**: `ANY /api/*path`

**æè¿°**: å°†è¯·æ±‚è½¬å‘åˆ°åç«¯å¾®æœåŠ¡ï¼Œæ”¯æŒè´Ÿè½½å‡è¡¡

**è¯·æ±‚å¤´**:

```
Cookie: access_token=your_jwt_token
Content-Type: application/json (POST/PUTè¯·æ±‚)
```

**è¯·æ±‚å‚æ•°**:

- **è·¯å¾„å‚æ•°**: `path` - æœåŠ¡è·¯å¾„ï¼Œç”¨äºåŒ¹é…å¯¹åº”çš„åç«¯æœåŠ¡
- **æŸ¥è¯¢å‚æ•°**: `cmd` - å¿…å¡«ï¼Œç›®æ ‡æœåŠ¡çš„å…·ä½“è·¯å¾„
- **è¯·æ±‚ä½“**: æ ¹æ®ç›®æ ‡æœåŠ¡è¦æ±‚

**å“åº”**: ç›´æ¥è¿”å›åç«¯æœåŠ¡çš„å“åº”

**è¯·æ±‚ç¤ºä¾‹**:

```bash
# è½¬å‘åˆ°ç”¨æˆ·æœåŠ¡
GET /api/user-service?cmd=users/profile

# è½¬å‘åˆ°é¢˜ç›®æœåŠ¡
POST /api/problem-service?cmd=problems
```

**å“åº”ç¤ºä¾‹**:

```json
// æˆåŠŸå“åº” - è¿”å›åç«¯æœåŠ¡å“åº”
{
  // åç«¯æœåŠ¡çš„å®é™…å“åº”å†…å®¹
}

// æœåŠ¡ä¸å­˜åœ¨ (404)
{
  "error": "service not found"
}

// æ— å¥åº·å®ä¾‹ (503)
{
  "error": "no healthy instance found"
}

// åç«¯æœåŠ¡é”™è¯¯ (502)
{
  "error": "backend service error"
}

// æœªè®¤è¯ (401)
{
  "error": "tokenä¸å­˜åœ¨"
}
```

**è¯´æ˜**:

- éœ€è¦ JWT è®¤è¯
- è‡ªåŠ¨æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´ (X-User-ID, X-Request-ID, X-Forwarded-By)
- æ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ç­–ç•¥
- è‡ªåŠ¨å¥åº·æ£€æŸ¥å’Œæ•…éšœè½¬ç§»
- æ”¯æŒæ‰€æœ‰ HTTP æ–¹æ³• (GET, POST, PUT, DELETE ç­‰)

## æœåŠ¡ç®¡ç† API (ç®¡ç†å‘˜æ¥å£, å·²å¼ƒç”¨)

### 6. è·å–æ‰€æœ‰æœåŠ¡

**æ¥å£åœ°å€**: `GET /admin/proxy/services`

**æè¿°**: è·å–å½“å‰ç½‘å…³ç®¡ç†çš„æ‰€æœ‰æœåŠ¡é…ç½®

**è¯·æ±‚å¤´**:

```
Cookie: access_token=your_jwt_token
```

**è¯·æ±‚å‚æ•°**: æ— 

**å“åº”ç¤ºä¾‹**:

```json
{
  "user-service": {
    "service_name": "user-service",
    "instances": [
      {
        "url": "http://localhost:8081",
        "weight": 1,
        "healthy": true,
        "last_check": "2024-12-20T10:30:00Z"
      }
    ],
    "health_check": "/health",
    "load_balancer": "round_robin"
  },
  "problem-service": {
    "service_name": "problem-service",
    "instances": [
      {
        "url": "http://localhost:8082",
        "weight": 2,
        "healthy": true,
        "last_check": "2024-12-20T10:30:00Z"
      }
    ],
    "health_check": "/health",
    "load_balancer": "weighted_random"
  }
}
```

**æƒé™è¦æ±‚**: ç®¡ç†å‘˜æƒé™

### 7. æ·»åŠ æœåŠ¡

**æ¥å£åœ°å€**: `POST /admin/proxy/services`

**æè¿°**: æ·»åŠ æ–°çš„åç«¯æœåŠ¡é…ç½®

**è¯·æ±‚å¤´**:

```
Cookie: access_token=your_jwt_token
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**:

```json
[
  {
    "service_name": "string", // å¿…å¡«ï¼ŒæœåŠ¡åç§°ï¼Œå”¯ä¸€æ ‡è¯†
    "instances": [
      {
        "url": "string", // å¿…å¡«ï¼ŒæœåŠ¡å®ä¾‹URLï¼Œæ ¼å¼: http://host:port
        "weight": 1, // å¯é€‰ï¼Œæƒé‡ï¼Œé»˜è®¤1ï¼ŒèŒƒå›´1-100
        "healthy": true // å¯é€‰ï¼Œå¥åº·çŠ¶æ€ï¼Œé»˜è®¤true
      }
    ],
    "health_check": "string", // å¿…å¡«ï¼Œå¥åº·æ£€æŸ¥è·¯å¾„ï¼Œå¦‚: /health
    "load_balancer": "string" // å¿…å¡«ï¼Œè´Ÿè½½å‡è¡¡ç­–ç•¥
  }
]
```

**è´Ÿè½½å‡è¡¡ç­–ç•¥**:

- `round_robin`: è½®è¯¢
- `random`: éšæœº
- `weighted_random`: åŠ æƒéšæœº
- `weighted_round_robin`: åŠ æƒè½®è¯¢

**å“åº”ç¤ºä¾‹**:

```json
// æˆåŠŸå“åº” (200)
{
  "message": "service added"
}

// å‚æ•°é”™è¯¯ (400)
{
  "error": "Key: 'ServiceConfig.ServiceName' Error:Field validation for 'ServiceName' failed on the 'required' tag"
}

// æƒé™ä¸è¶³ (403)
{
  "error": "æƒé™ä¸è¶³"
}
```

**æƒé™è¦æ±‚**: ç®¡ç†å‘˜æƒé™

### 8. åˆ é™¤æœåŠ¡

**æ¥å£åœ°å€**: `DELETE /admin/proxy/services?service=æœåŠ¡å`

**æè¿°**: åˆ é™¤æŒ‡å®šçš„æœåŠ¡é…ç½®

**è¯·æ±‚å¤´**:

```
Cookie: access_token=your_jwt_token
```

**è¯·æ±‚å‚æ•°**:

- **Query å‚æ•°**: `service` (å¿…å¡«ï¼ŒæœåŠ¡åç§°)

**å“åº”ç¤ºä¾‹**:

```json
// æˆåŠŸå“åº” (200)
{
  "message": "service removed"
}

// æœåŠ¡ä¸å­˜åœ¨ (404)
{
  "error": "service not found"
}

// æƒé™ä¸è¶³ (403)
{
  "error": "æƒé™ä¸è¶³"
}
```

**æƒé™è¦æ±‚**: ç®¡ç†å‘˜æƒé™

### 9. è·å–æœåŠ¡å®ä¾‹

**æ¥å£åœ°å€**: `GET /admin/proxy/services/{service}/instances`

**æè¿°**: è·å–æŒ‡å®šæœåŠ¡çš„æ‰€æœ‰å®ä¾‹

**è¯·æ±‚å¤´**:

```
Cookie: access_token=your_jwt_token
```

**è¯·æ±‚å‚æ•°**:

- **è·¯å¾„å‚æ•°**: `service` (å¿…å¡«ï¼ŒæœåŠ¡åç§°)

**å“åº”ç¤ºä¾‹**:

```json
[
  {
    "url": "http://localhost:8081",
    "weight": 1,
    "healthy": true,
    "last_check": "2024-12-20T10:30:00Z"
  },
  {
    "url": "http://localhost:8082",
    "weight": 2,
    "healthy": false,
    "last_check": "2024-12-20T10:29:45Z"
  }
]
```

**æƒé™è¦æ±‚**: ç®¡ç†å‘˜æƒé™

### 10. æ·»åŠ æœåŠ¡å®ä¾‹

**æ¥å£åœ°å€**: `POST /admin/proxy/services/{service}/instances`

**æè¿°**: ä¸ºæŒ‡å®šæœåŠ¡æ·»åŠ æ–°çš„å®ä¾‹

**è¯·æ±‚å¤´**:

```
Cookie: access_token=your_jwt_token
Content-Type: application/json
```

**è¯·æ±‚å‚æ•°**:

```json
[
  {
    "url": "string", // å¿…å¡«ï¼Œå®ä¾‹URLï¼Œæ ¼å¼: http://host:port
    "weight": 1, // å¯é€‰ï¼Œæƒé‡ï¼Œé»˜è®¤1ï¼ŒèŒƒå›´1-100
    "healthy": true // å¯é€‰ï¼Œå¥åº·çŠ¶æ€ï¼Œé»˜è®¤true
  }
]
```

**å“åº”ç¤ºä¾‹**:

```json
// æˆåŠŸå“åº” (200)
{
  "message": "instance added"
}

// æœåŠ¡ä¸å­˜åœ¨ (404)
{
  "error": "service not found"
}

// å‚æ•°é”™è¯¯ (400)
{
  "error": "Key: 'ServiceInstance.URL' Error:Field validation for 'URL' failed on the 'required' tag"
}

// æƒé™ä¸è¶³ (403)
{
  "error": "æƒé™ä¸è¶³"
}
```

**æƒé™è¦æ±‚**: ç®¡ç†å‘˜æƒé™

### 11. åˆ é™¤æœåŠ¡å®ä¾‹

**æ¥å£åœ°å€**: `DELETE /admin/proxy/services/{service}/instance?instance=å®ä¾‹URL`

**æè¿°**: åˆ é™¤æŒ‡å®šæœåŠ¡çš„æŒ‡å®šå®ä¾‹

**è¯·æ±‚å¤´**:

```
Cookie: access_token=your_jwt_token
```

**è¯·æ±‚å‚æ•°**:

- **è·¯å¾„å‚æ•°**: `service` (å¿…å¡«ï¼ŒæœåŠ¡åç§°)
- **Query å‚æ•°**: `instance` (å¿…å¡«ï¼Œå®ä¾‹ URL)

**å“åº”ç¤ºä¾‹**:

```json
// æˆåŠŸå“åº” (200)
{
  "message": "instance removed"
}

// å®ä¾‹ä¸å­˜åœ¨ (404)
{
  "error": "instance not found"
}

// æœåŠ¡ä¸å­˜åœ¨ (404)
{
  "error": "service not found"
}

// æƒé™ä¸è¶³ (403)
{
  "error": "æƒé™ä¸è¶³"
}
```

**æƒé™è¦æ±‚**: ç®¡ç†å‘˜æƒé™

## æ•°æ®æ¨¡å‹

### LoginRequest (ç™»å½•è¯·æ±‚)

```json
{
  "username": "string", // ç”¨æˆ·åï¼Œå¿…å¡«ï¼Œé•¿åº¦1-50å­—ç¬¦
  "password": "string" // å¯†ç ï¼Œå¿…å¡«ï¼Œé•¿åº¦6-100å­—ç¬¦
}
```

### InfoResponse (ç”¨æˆ·ä¿¡æ¯å“åº”)

```json
{
  "username": "string", // ç”¨æˆ·å
  "realname": "string", // çœŸå®å§“å
  "role": 1, // ç”¨æˆ·è§’è‰² (1=ç®¡ç†å‘˜, 0=æ™®é€šç”¨æˆ·)
  "status": 1 // ç”¨æˆ·çŠ¶æ€ (1=æ­£å¸¸, 0=ç¦ç”¨)
}
```

### ServiceInstance (æœåŠ¡å®ä¾‹)

```json
{
  "url": "string", // å®ä¾‹URLï¼Œå¿…å¡«ï¼Œæ ¼å¼: http://host:port
  "weight": 1, // æƒé‡ï¼Œç”¨äºåŠ æƒè´Ÿè½½å‡è¡¡ï¼ŒèŒƒå›´1-100
  "healthy": true, // å¥åº·çŠ¶æ€
  "last_check": "string" // æœ€åæ£€æŸ¥æ—¶é—´ (ISO 8601æ ¼å¼)
}
```

### ServiceConfig (æœåŠ¡é…ç½®)

```json
{
  "service_name": "string", // æœåŠ¡åç§°ï¼Œå¿…å¡«ï¼Œå”¯ä¸€æ ‡è¯†
  "instances": [], // æœåŠ¡å®ä¾‹åˆ—è¡¨
  "health_check": "string", // å¥åº·æ£€æŸ¥è·¯å¾„ï¼Œå¿…å¡«ï¼Œå¦‚: /health
  "load_balancer": "string" // è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå¿…å¡«
}
```

### UserClaims (JWT ç”¨æˆ·å£°æ˜)

```json
{
  "user_id": 123, // ç”¨æˆ·ID
  "ssid": "string", // ä¼šè¯ID
  "user_agent": "string" // ç”¨æˆ·ä»£ç†
}
```

## é”™è¯¯ç è¯´æ˜

| HTTP çŠ¶æ€ç  | é”™è¯¯ç±»å‹   | è¯´æ˜             | ç¤ºä¾‹                         |
| ----------- | ---------- | ---------------- | ---------------------------- |
| 200         | æˆåŠŸ       | è¯·æ±‚æˆåŠŸ         | æ­£å¸¸å“åº”                     |
| 400         | å®¢æˆ·ç«¯é”™è¯¯ | è¯·æ±‚å‚æ•°é”™è¯¯     | å‚æ•°éªŒè¯å¤±è´¥ã€JSON æ ¼å¼é”™è¯¯  |
| 401         | è®¤è¯é”™è¯¯   | æœªè®¤è¯æˆ–è®¤è¯å¤±è´¥ | Token ä¸å­˜åœ¨ã€Token è¿‡æœŸ     |
| 403         | æƒé™é”™è¯¯   | æƒé™ä¸è¶³         | éç®¡ç†å‘˜è®¿é—®ç®¡ç†æ¥å£         |
| 404         | èµ„æºé”™è¯¯   | èµ„æºä¸å­˜åœ¨       | æœåŠ¡ä¸å­˜åœ¨ã€å®ä¾‹ä¸å­˜åœ¨       |
| 500         | æœåŠ¡å™¨é”™è¯¯ | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯   | æ•°æ®åº“è¿æ¥å¤±è´¥ã€ä¸šåŠ¡é€»è¾‘é”™è¯¯ |
| 502         | ç½‘å…³é”™è¯¯   | åç«¯æœåŠ¡é”™è¯¯     | åç«¯æœåŠ¡ä¸å¯è¾¾ã€å“åº”å¼‚å¸¸     |
| 503         | æœåŠ¡ä¸å¯ç”¨ | æœåŠ¡ä¸å¯ç”¨       | æ— å¥åº·å®ä¾‹å¯ç”¨               |

## è®¤è¯æœºåˆ¶

### JWT Token

- **ä¼ é€’æ–¹å¼**: é€šè¿‡ Cookie ä¼ é€’ (access_token)
- **Token å†…å®¹**: åŒ…å«ç”¨æˆ· IDã€ä¼šè¯ ID å’Œç”¨æˆ·ä»£ç†ä¿¡æ¯
- **æœ‰æ•ˆæœŸ**: å¯é…ç½®ï¼Œé»˜è®¤ 24 å°æ—¶
- **åˆ·æ–°æœºåˆ¶**: æ”¯æŒ Token è‡ªåŠ¨åˆ·æ–°
- **ä¼šè¯ç®¡ç†**: åŸºäº Redis çš„ä¼šè¯å­˜å‚¨

### æƒé™æ§åˆ¶

- **ç™»å½•æ£€æŸ¥**: å¤§éƒ¨åˆ† API éœ€è¦ç”¨æˆ·ç™»å½•
- **ç®¡ç†å‘˜æ£€æŸ¥**: æœåŠ¡ç®¡ç† API éœ€è¦ç®¡ç†å‘˜æƒé™ (role=1)
- **è·¯å¾„ç™½åå•**: æ”¯æŒé…ç½®æ— éœ€è®¤è¯çš„è·¯å¾„
  - `/auth/login` - ç™»å½•æ¥å£
  - `/health` - å¥åº·æ£€æŸ¥æ¥å£

### å®‰å…¨ç‰¹æ€§

- **å¯†ç åŠ å¯†**: ä½¿ç”¨ bcrypt åŠ å¯†å­˜å‚¨
- **ä¼šè¯ç®¡ç†**: Redis å­˜å‚¨ä¼šè¯ä¿¡æ¯ï¼Œæ”¯æŒå•ç‚¹ç™»å½•æ§åˆ¶
- **è¯·æ±‚è¿½è¸ª**: è‡ªåŠ¨ç”Ÿæˆè¯·æ±‚ IDï¼Œä¾¿äºæ—¥å¿—è¿½è¸ª

## è´Ÿè½½å‡è¡¡ç­–ç•¥

### 1. è½®è¯¢ (round_robin)

- **ç®—æ³•**: æŒ‰é¡ºåºè½®æµé€‰æ‹©å¥åº·çš„æœåŠ¡å®ä¾‹
- **é€‚ç”¨åœºæ™¯**: å®ä¾‹æ€§èƒ½ç›¸è¿‘çš„åœºæ™¯
- **ç‰¹ç‚¹**: ç®€å•å…¬å¹³ï¼Œåˆ†å¸ƒå‡åŒ€

### 2. éšæœº (random)

- **ç®—æ³•**: éšæœºé€‰æ‹©å¥åº·çš„æœåŠ¡å®ä¾‹
- **é€‚ç”¨åœºæ™¯**: å®ä¾‹æ€§èƒ½ç›¸è¿‘ï¼Œå¯¹é¡ºåºæ— è¦æ±‚
- **ç‰¹ç‚¹**: å®ç°ç®€å•ï¼Œåˆ†å¸ƒç›¸å¯¹å‡åŒ€

### 3. åŠ æƒéšæœº (weighted_random)

- **ç®—æ³•**: æ ¹æ®å®ä¾‹æƒé‡è¿›è¡ŒåŠ æƒéšæœºé€‰æ‹©
- **é€‚ç”¨åœºæ™¯**: å®ä¾‹æ€§èƒ½å·®å¼‚è¾ƒå¤§çš„åœºæ™¯
- **ç‰¹ç‚¹**: é«˜æƒé‡å®ä¾‹è·å¾—æ›´å¤šè¯·æ±‚

### 4. åŠ æƒè½®è¯¢ (weighted_round_robin)

- **ç®—æ³•**: æ ¹æ®å®ä¾‹æƒé‡è¿›è¡ŒåŠ æƒè½®è¯¢é€‰æ‹©
- **é€‚ç”¨åœºæ™¯**: å®ä¾‹æ€§èƒ½å·®å¼‚è¾ƒå¤§ï¼Œéœ€è¦ç²¾ç¡®æ§åˆ¶åˆ†é…æ¯”ä¾‹
- **ç‰¹ç‚¹**: ä¸¥æ ¼æŒ‰æƒé‡æ¯”ä¾‹åˆ†é…è¯·æ±‚

## å¥åº·æ£€æŸ¥

### æ£€æŸ¥æœºåˆ¶

- **æ£€æŸ¥é—´éš”**: å¯é…ç½®ï¼Œé»˜è®¤ 30 ç§’
- **æ£€æŸ¥è¶…æ—¶**: å¯é…ç½®ï¼Œé»˜è®¤ 5 ç§’
- **æ£€æŸ¥æ–¹å¼**: HTTP GET è¯·æ±‚åˆ°å¥åº·æ£€æŸ¥è·¯å¾„
- **å¹¶å‘æ£€æŸ¥**: æ”¯æŒå¤šå®ä¾‹å¹¶å‘å¥åº·æ£€æŸ¥

### æ•…éšœå¤„ç†

- **è‡ªåŠ¨æ•…éšœè½¬ç§»**: ä¸å¥åº·çš„å®ä¾‹è‡ªåŠ¨ä»è´Ÿè½½å‡è¡¡ä¸­ç§»é™¤
- **è‡ªåŠ¨æ¢å¤**: å®ä¾‹æ¢å¤å¥åº·åè‡ªåŠ¨é‡æ–°åŠ å…¥è´Ÿè½½å‡è¡¡
- **çŠ¶æ€è®°å½•**: è®°å½•æ¯ä¸ªå®ä¾‹çš„æœ€åæ£€æŸ¥æ—¶é—´å’ŒçŠ¶æ€

### é…ç½®ç¤ºä¾‹

```yaml
health_check:
  interval: 30s # æ£€æŸ¥é—´éš”
  timeout: 5s # æ£€æŸ¥è¶…æ—¶
  path: "/health" # æ£€æŸ¥è·¯å¾„
```

## ä¸­é—´ä»¶

### 1. CORS ä¸­é—´ä»¶

- **åŠŸèƒ½**: æ”¯æŒè·¨åŸŸè¯·æ±‚é…ç½®
- **é…ç½®é¡¹**:
  - å…è®¸çš„æ¥æº (Origins)
  - å…è®¸çš„æ–¹æ³• (Methods)
  - å…è®¸çš„è¯·æ±‚å¤´ (Headers)
  - æ˜¯å¦å…è®¸å‡­è¯ (Credentials)

### 2. JWT ä¸­é—´ä»¶

- **åŠŸèƒ½**: è‡ªåŠ¨éªŒè¯ JWT Token
- **ç‰¹æ€§**:
  - æå–ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡
  - æ”¯æŒè·¯å¾„ç™½åå•é…ç½®
  - è‡ªåŠ¨å¤„ç† Token è¿‡æœŸå’Œåˆ·æ–°

### 3. æ—¥å¿—ä¸­é—´ä»¶

- **åŠŸèƒ½**: è®°å½•è¯·æ±‚å“åº”æ—¥å¿—
- **ç‰¹æ€§**:
  - æ”¯æŒç»“æ„åŒ–æ—¥å¿—è¾“å‡º
  - åŒ…å«è¯·æ±‚ IDã€ç”¨æˆ· ID ç­‰ä¸Šä¸‹æ–‡ä¿¡æ¯
  - è®°å½•è¯·æ±‚è€—æ—¶å’Œå“åº”çŠ¶æ€

## ä½¿ç”¨ç¤ºä¾‹

### 1. ç”¨æˆ·ç™»å½•

```bash
curl -X POST http://localhost:8080/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "password"}' \
  -c cookies.txt
```

### 2. è·å–ç”¨æˆ·ä¿¡æ¯

```bash
curl -X GET http://localhost:8080/auth/info \
  -b cookies.txt
```

### 3. æ·»åŠ æœåŠ¡ (ç®¡ç†å‘˜)

```bash
curl -X POST http://localhost:8080/admin/proxy/services \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '[{
    "service_name": "user-service",
    "instances": [{"url": "http://localhost:8081", "weight": 1}],
    "health_check": "/health",
    "load_balancer": "round_robin"
  }]'
```

### 4. æœåŠ¡è½¬å‘

```bash
curl -X GET "http://localhost:8080/api/user-service?cmd=users/profile" \
  -b cookies.txt
```

### 5. è·å–æ‰€æœ‰æœåŠ¡ (ç®¡ç†å‘˜)

```bash
curl -X GET http://localhost:8080/admin/proxy/services \
  -b cookies.txt
```

### 6. å¥åº·æ£€æŸ¥

```bash
curl -X GET http://localhost:8080/health
```

## éƒ¨ç½²è¯´æ˜

### ç¯å¢ƒå˜é‡

```bash
# Ginè¿è¡Œæ¨¡å¼
GIN_MODE=release

# æ•°æ®åº“è¿æ¥
DB_DSN=user:password@tcp(localhost:3306)/online_judge?charset=utf8mb4&parseTime=True&loc=Local

# Redisé…ç½®
REDIS_ADDR=localhost:6379
REDIS_PASSWORD=
REDIS_DB=0

# JWTé…ç½®
JWT_SECRET=your_jwt_secret_key

# æœåŠ¡é…ç½®
SERVER_PORT=8080
LOG_LEVEL=info
```

### Docker éƒ¨ç½²

```bash
# æ„å»ºé•œåƒ
docker build -t online-judge-gateway .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name gateway \
  -p 8080:8080 \
  -e DB_DSN="user:password@tcp(db:3306)/online_judge" \
  -e REDIS_ADDR="redis:6379" \
  online-judge-gateway
```

### é…ç½®æ–‡ä»¶

å‚è€ƒ `config/config.template.yaml` è¿›è¡Œé…ç½®ï¼š

```yaml
server:
  port: 8080
  mode: release

database:
  dsn: "user:password@tcp(localhost:3306)/online_judge"

redis:
  addr: "localhost:6379"
  password: ""
  db: 0

jwt:
  secret: "your_jwt_secret"
  expire: 24h

proxy:
  health_check_interval: 30s
  health_check_timeout: 5s
```

### è®¡åˆ’ä¸­çš„åŠŸèƒ½

- ğŸ”„ æœåŠ¡å‘ç°é›†æˆ (Consul/Etcd)
- ğŸ”„ API é™æµå’Œç†”æ–­æœºåˆ¶
- ğŸ”„ ç›‘æ§å’ŒæŒ‡æ ‡æ”¶é›†
- ğŸ”„ é…ç½®çƒ­é‡è½½
- ğŸ”„ gRPC æœåŠ¡ä»£ç†æ”¯æŒ

---

**æ³¨æ„**:

1. æœ¬æ–‡æ¡£åŸºäºå½“å‰ä»£ç ç»“æ„ç”Ÿæˆï¼Œå¦‚æœ‰ API å˜æ›´è¯·åŠæ—¶æ›´æ–°æ–‡æ¡£
2. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰è¯·ä»”ç»†é…ç½®å®‰å…¨ç›¸å…³å‚æ•°
3. å»ºè®®å®šæœŸå¤‡ä»½é…ç½®å’Œæ—¥å¿—æ–‡ä»¶
